<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>合约手续费与盈亏计算器 — V7（双语言 / VIP费率 单一仓位全平&百分比分仓）</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --muted:#8a8f98; --fg:#e8edf2; --accent:#4da3ff; --ok:#22c55e; --bad:#ef4444; --border:#242833; }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{max-width:1080px;margin:32px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:16px;padding:20px 18px;box-shadow:0 4px 30px rgba(0,0,0,.25);}
    h1{font-size:22px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end}
    .col-2{grid-column:span 2}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
    input,select{width:100%;box-sizing:border-box;background:#0f1115;color:var(--fg);border:1px solid #23262d;border-radius:10px;padding:10px 12px;outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.2)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .btn{cursor:pointer;border:1px solid #2a3039;background:#10131a;color:var(--fg);padding:10px 14px;border-radius:12px}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#081018}
    .stat{display:flex;justify-content:space-between;border:1px solid var(--border);background:#0e1016;padding:10px 12px;border-radius:12px}
    .stat .label{color:var(--muted);font-size:13px}
    .stat .value{font-weight:700}
    .pos{color:var(--ok)} .neg{color:var(--bad)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .switch{display:flex;gap:6px;background:#0f1116;border:1px solid #23262d;border-radius:10px;padding:4px}
    .switch>button{flex:1;border:0;background:transparent;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .switch>button.active{color:var(--fg);background:#1a1f2a}
    .right{justify-content:flex-end}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .lang{display:flex;gap:6px}
    .lang button{border:1px solid #2a3039;background:#10131a;color:var(--fg);padding:6px 10px;border-radius:10px;cursor:pointer}
    .lang button.active{border-color:var(--accent);background:#162033}
    code{background:#0f141c;border:1px solid #202535;color:#e6edf3;padding:2px 6px;border-radius:6px}
    @media (max-width:900px){.col-2,.col-3,.col-4,.col-6,.col-12{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1 id="title">合约手续费与盈亏计算器 V7</h1>
          <div class="muted" id="subtitle">支持 VIP 费率、开/平 Maker/Taker、全平/按百分比分仓；未实现盈亏按剩余持仓量计算。</div>
        </div>
        <div class="lang" aria-label="Language">
          <button id="lang-zh" class="active">中文</button>
          <button id="lang-en">English</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div class="col-12">
          <label id="lbl_dir_lev_tools">方向 / 杠杆 / 平仓便捷操作</label>
          <div class="row">
            <div class="switch" role="tablist" aria-label="方向">
              <button id="side-long" class="active" data-side="long" aria-pressed="true">做多 Long</button>
              <button id="side-short" data-side="short" aria-pressed="false">做空 Short</button>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <label for="leverage" style="margin:0;color:var(--muted);font-size:13px" id="lbl_leverage">杠杆（×）</label>
              <input id="leverage" type="number" inputmode="decimal" step="0.1" min="1" value="20" style="width:120px" />
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <label for="notionalValue" style="margin:0;color:var(--muted);font-size:13px" id="lbl_notionalValue">名义价值（USDT）</label>
              <input id="notionalValue" type="number" inputmode="decimal" step="0.01" placeholder="输入名义价值" style="width:120px" />
            </div>
            <button class="btn" id="btnFullClose" title="将平仓量设为等于开仓量">全部平仓</button>
            <div class="row" style="gap:8px;align-items:center">
              <label for="partialPct" style="margin:0;color:var(--muted);font-size:13px" id="lbl_partialPct">部分平仓 %</label>
              <input id="partialPct" type="number" inputmode="decimal" step="0.01" min="0" max="100" placeholder="例如 25" style="width:120px" />
              <button class="btn" id="btnApplyPct">应用</button>
            </div>
          </div>
        </div>
        <div class="col-3">
          <label for="openPrice" id="lbl_openPrice">开仓价格</label>
          <input id="openPrice" type="number" inputmode="decimal" step="0.01" value="7000" />
        </div>
        <div class="col-3">
          <label for="openQty" id="lbl_openQty">开仓数量（币）</label>
          <input id="openQty" type="number" inputmode="decimal" step="0.0001" value="20" />
        </div>
        <div class="col-3">
          <label for="closePrice" id="lbl_closePrice">平仓价格</label>
          <input id="closePrice" type="number" inputmode="decimal" step="0.01" value="8000" />
        </div>
        <div class="col-3">
          <label for="closeQty" id="lbl_closeQty">平仓数量（币）</label>
          <input id="closeQty" type="number" inputmode="decimal" step="0.0001" value="10" />
        </div>
        <div class="col-3">
          <label for="currentPrice" id="lbl_currentPrice">当前价格</label>
          <input id="currentPrice" type="number" inputmode="decimal" step="0.01" value="8000" />
        </div>
        <div class="col-3">
          <label for="vipLevel" id="lbl_vip">VIP 等级（自动费率）</label>
          <select id="vipLevel">
            <option value="0" selected>VIP0 — Taker 0.080% / Maker 0.020%</option>
            <option value="1">VIP1 — Taker 0.075% / Maker 0.020%</option>
            <option value="2">VIP2 — Taker 0.060% / Maker 0.018%</option>
            <option value="3">VIP3 — Taker 0.055% / Maker 0.018%</option>
            <option value="4">VIP4 — Taker 0.050% / Maker 0.016%</option>
            <option value="5">VIP5 — Taker 0.048% / Maker 0.016%</option>
            <option value="6">VIP6 — Taker 0.045% / Maker 0.014%</option>
            <option value="7">VIP7 — Taker 0.042% / Maker 0.012%</option>
            <option value="8">VIP8 — Taker 0.040% / Maker 0.010%</option>
          </select>
        </div>
        <div class="col-3">
          <label id="lbl_openFeeType">开仓手续费类型</label>
          <div class="switch" role="tablist" aria-label="开仓手续费类型">
            <button id="open-fee-maker" data-feeopen="maker">Maker</button>
            <button id="open-fee-taker" class="active" data-feeopen="taker" aria-pressed="true">Taker</button>
          </div>
        </div>
        <div class="col-3">
          <label id="lbl_closeFeeType">平仓手续费类型</label>
          <div class="switch" role="tablist" aria-label="平仓手续费类型">
            <button id="close-fee-maker" data-feeclose="maker">Maker</button>
            <button id="close-fee-taker" class="active" data-feeclose="taker" aria-pressed="true">Taker</button>
          </div>
        </div>
        <div class="col-12 row right">
          <button class="btn" id="exampleBtn">一键填入示例（7000/8000）</button>
          <button class="btn" id="resetBtn" title="清空表单">清空</button>
          <button class="btn primary" id="calcBtn">计算</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid" id="results" aria-live="polite">
        <div class="col-4"><div class="stat"><div class="label" id="lbl_feeOpen">开仓手续费</div><div class="value" id="feeOpen">-</div></div></div>
        <div class="col-4"><div class="stat"><div class="label" id="lbl_feeClose">平仓手续费</div><div class="value" id="feeClose">-</div></div></div>
        <div class="col-4"><div class="stat"><div class="label" id="lbl_feeTotal">总手续费</div><div class="value" id="feeTotal">-</div></div></div>
        <div class="col-4"><div class="stat"><div class="label" id="lbl_notional">名义价值（Notional）</div><div class="value" id="notional">-</div></div></div>
        <div class="col-4"><div class="stat"><div class="label" id="lbl_openQtyResult">开仓数量（币）</div><div class="value" id="openQtyResult">-</div></div></div>
        <div class="col-4"><div class="stat"><div class="label" id="lbl_pnlRaw">已实现盈亏（不含手续费）</div><div class="value" id="pnlRaw">-</div></div></div>
        <div class="col-6"><div class="stat"><div class="label" id="lbl_pnlNet">已实现盈亏（含手续费）</div><div class="value" id="pnlNet">-</div></div></div>
        <div class="col-6"><div class="stat"><div class="label" id="lbl_pnlUnreal">未实现盈亏（不含手续费）</div><div class="value" id="pnlUnreal">-</div></div></div>
      </div>
      <div class="hr"></div>
      <div class="muted" id="disclaimer">
        公式：<ul><code>开仓手续费 = 开仓价 × 开仓量 × 费率</code>；</ul>
		<code>平仓手续费 = 平仓价 × 平仓量 × 费率</code>；
        <code>名义价值 = 开仓价 × 开仓量</code>；
		<code>开仓数量（币）= 名义价值 / 开仓价</code>；
        <code>未实现盈亏</code> 按 <code>剩余持仓量</code> 计算。
      </div>
    </div>
  </div>
  <script>
    const $ = (id)=>document.getElementById(id);
    const state = { side:'long', feeOpen:'taker', feeClose:'taker', unit:'USDT', lang:'zh' };
    const t = {
      zh: {
        title:'合约手续费与盈亏计算器 V7',
        subtitle:'V7（双语言 样式；支持 VIP 费率、开/平 Maker/Taker、全平/按百分比分仓；未实现盈亏按剩余持仓量计算。',
        dirLevTools:'方向 / 杠杆 / 平仓便捷操作',
        leverage:'杠杆（×）',
        notionalValue:'名义价值（USDT）',
        fullClose:'全部平仓', apply:'应用', partialPct:'部分平仓 %', placeholderPct:'例如 25', placeholderNotionalValue: '输入名义价值',
        sideLong:'做多 Long', sideShort:'做空 Short',
        openPrice:'开仓价格', openQty:'开仓数量（币）', closePrice:'平仓价格', closeQty:'平仓数量（币）', currentPrice:'当前价格',
        vip:'VIP 等级（自动费率）',
        openFeeType:'开仓手续费类型', closeFeeType:'平仓手续费类型',
        example:'一键填入示例（7000/8000）', reset:'清空', calc:'计算',
        feeOpen:'开仓手续费', feeClose:'平仓手续费', feeTotal:'总手续费',
        notional:'名义价值（Notional）', openQtyResult:'开仓数量（币）',
        pnlRaw:'已实现盈亏（不含手续费）', pnlNet:'已实现盈亏（含手续费）', pnlUnreal:'未实现盈亏（不含手续费）',
        disclaimer:'公式：</br><code>开平仓手续费 = 开平仓价 × 开平仓量 × 费率</code>；</br><code>开平仓手续费 = 开平仓价 × 开平仓量 × 费率</code>；</br><code>名义价值 = 开平仓价 × 开平仓量</code>；</br><code>开平仓数量（币）= 名义价值 / 开平仓价</code>；</br><code>未实现盈亏</code> 按 <code>剩余持仓量</code> 计算。'
      },
      en: {
        title:'Futures Fee & PnL Calculator V7',
        subtitle:'V7 layout; supports VIP fees, Maker/Taker (open/close), close-all / partial by %, unrealized P&L on remaining position.',
        dirLevTools:'Direction / Leverage / Quick Close Tools',
        leverage:'Leverage (×)',
        notionalValue:'Notional Value (USDT)',
        fullClose:'Close All', apply:'Apply', partialPct:'Partial Close %', placeholderPct:'e.g. 25', placeholderNotionalValue: 'Enter Notional Value',
        sideLong:'Long', sideShort:'Short',
        openPrice:'Open Price', openQty:'Open Quantity (coin)', closePrice:'Close Price', closeQty:'Close Quantity (coin)', currentPrice:'Current Price',
        vip:'VIP Level (auto fee)',
        openFeeType:'Open Fee Type', closeFeeType:'Close Fee Type',
        example:'Fill Example (7000/8000)', reset:'Reset', calc:'Calculate',
        feeOpen:'Open Fee', feeClose:'Close Fee', feeTotal:'Total Fee',
        notional:'Notional Value', openQtyResult:'Open Quantity (coin)',
        pnlRaw:'Realized P&L (excl. fees)', pnlNet:'Realized P&L (incl. fees)', pnlUnreal:'Unrealized P&L (excl. fees)',
        disclaimer:'Formulas: </br><code>Opening/Closing Fee = Opening/Closing Price × Opening/Closing Quantity × Fee Rate</code>；</br><code>Opening/Closing Fee = Opening/Closing Price × Opening/Closing Quantity × Fee Rate;</code>；</br><code>Notional Value = Opening/Closing Price × Opening/Closing Quantity;</code>；</br><code>Opening/Closing Quantity (in currency) = Notional Value / Opening/Closing Price;</code>；</br><code>Unrealized P&L is calculated based on the Remaining Position Quantity</code>；'
      }
    };
    const vipRates = {
      0:{taker:0.0008, maker:0.0002},
      1:{taker:0.00075, maker:0.0002},
      2:{taker:0.00060, maker:0.00018},
      3:{taker:0.00055, maker:0.00018},
      4:{taker:0.0005, maker:0.00016},
      5:{taker:0.00048, maker:0.00016},
      6:{taker:0.00045, maker:0.00014},
      7:{taker:0.00042, maker:0.00012},
      8:{taker:0.0004, maker:0.0001}
    };
    function setSwitch(activeBtn){
      [...activeBtn.parentElement.children].forEach(btn=>{
        btn.classList.toggle('active', btn===activeBtn);
        btn.setAttribute('aria-pressed', btn===activeBtn ? 'true':'false');
      });
    }
    function setLang(lang){
      state.lang = lang;
      document.documentElement.lang = (lang==='zh'?'zh-CN':'en');
      const tt = t[lang];
      // 文案替换
      $('title').textContent = tt.title;
      $('subtitle').textContent = tt.subtitle;
      $('lbl_dir_lev_tools').textContent = tt.dirLevTools;
      $('lbl_leverage').textContent = tt.leverage;
      $('lbl_notionalValue').textContent = tt.notionalValue;
      $('btnFullClose').textContent = tt.fullClose;
      $('lbl_partialPct').textContent = tt.partialPct;
      $('btnApplyPct').textContent = tt.apply;
      $('partialPct').placeholder = tt.placeholderPct;
      $('notionalValue').placeholder = tt.placeholderNotionalValue; // 应用 placeholder
      $('side-long').textContent = tt.sideLong;
      $('side-short').textContent = tt.sideShort;
      $('lbl_openPrice').textContent = tt.openPrice;
      $('lbl_openQty').textContent = tt.openQty;
      $('lbl_closePrice').textContent = tt.closePrice;
      $('lbl_closeQty').textContent = tt.closeQty;
      $('lbl_currentPrice').textContent = tt.currentPrice;
      $('lbl_vip').textContent = tt.vip;
      $('lbl_openFeeType').textContent = tt.openFeeType;
      $('lbl_closeFeeType').textContent = tt.closeFeeType;
      $('exampleBtn').textContent = tt.example;
      $('resetBtn').textContent = tt.reset;
      $('calcBtn').textContent = tt.calc;
      $('lbl_feeOpen').textContent = tt.feeOpen;
      $('lbl_feeClose').textContent = tt.feeClose;
      $('lbl_feeTotal').textContent = tt.feeTotal;
      $('lbl_notional').textContent = tt.notional;
      $('lbl_openQtyResult').textContent = tt.openQtyResult;
      $('lbl_pnlRaw').textContent = tt.pnlRaw;
      $('lbl_pnlNet').textContent = tt.pnlNet;
      $('lbl_pnlUnreal').textContent = tt.pnlUnreal;
      $('disclaimer').innerHTML = tt.disclaimer;
      // 切换按钮高亮
      $('lang-zh').classList.toggle('active', lang==='zh');
      $('lang-en').classList.toggle('active', lang==='en');
    }
    // 方向切换
    $('side-long').onclick = (e)=>{ state.side='long'; setSwitch(e.currentTarget); calc(); };
    $('side-short').onclick = (e)=>{ state.side='short'; setSwitch(e.currentTarget); calc(); };
    // Maker/Taker 费率类型
    $('open-fee-maker').onclick = (e)=>{ setSwitch(e.currentTarget); state.feeOpen='maker'; calc(); };
    $('open-fee-taker').onclick = (e)=>{ setSwitch(e.currentTarget); state.feeOpen='taker'; calc(); };
    $('close-fee-maker').onclick = (e)=>{ setSwitch(e.currentTarget); state.feeClose='maker'; calc(); };
    $('close-fee-taker').onclick = (e)=>{ setSwitch(e.currentTarget); state.feeClose='taker'; calc(); };
    // 全部平仓 / 百分比分仓
    $('btnFullClose').onclick = ()=>{ const oq = num($('openQty').value)||0; $('closeQty').value = oq; calc(); };
    $('btnApplyPct').onclick = ()=>{ applyPct(); };
    $('partialPct').addEventListener('input', ()=>{ applyPct(); });
    function applyPct(){
      const pct = Math.max(0, Math.min(100, num($('partialPct').value)));
      const oq = num($('openQty').value)||0;
      if (!isNaN(pct) && oq>0){ $('closeQty').value = +(oq * pct/100).toFixed(8); calc(); }
    }
    // 语言切换
    $('lang-zh').addEventListener('click', ()=> setLang('zh'));
    $('lang-en').addEventListener('click', ()=> setLang('en'));
    // 常规按钮
    $('resetBtn').onclick = ()=>{
      $('openPrice').value=7000; $('openQty').value=20; $('closePrice').value=8000; $('closeQty').value=10; $('currentPrice').value=8000; $('leverage').value=20; $('notionalValue').value=''; $('vipLevel').value='0';
      $('side-long').click(); $('open-fee-taker').click(); $('close-fee-taker').click(); $('partialPct').value='';
      renderResults(null);
    };
    $('exampleBtn').onclick = ()=>{
      $('openPrice').value=7000; $('openQty').value=20; $('closePrice').value=8000; $('closeQty').value=10; $('currentPrice').value=8000; $('leverage').value=20; $('notionalValue').value=''; $('vipLevel').value='0';
      $('side-long').click(); $('open-fee-taker').click(); $('close-fee-taker').click(); $('partialPct').value='';
      calc();
    };
    $('calcBtn').onclick = calc;
    // 输入变更 => 计算
    ['openPrice','openQty','closePrice','closeQty','currentPrice','leverage','notionalValue','vipLevel']
      .forEach(id=> document.getElementById(id).addEventListener('input', calc));
    function num(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; }
    function fmtMoney(n){ if (!Number.isFinite(n)) return '-'; return (n>0?'+':'') + n.toFixed(6) + ' ' + state.unit; }
    function fmtPlain(n){ if (!Number.isFinite(n)) return '-'; return n.toFixed(6) + ' ' + state.unit; }
    const getRates = ()=> vipRates[ parseInt($('vipLevel').value,10) ] || vipRates[0];
    function calc(){
      const openPrice = num($('openPrice').value);
      const openQty   = num($('openQty').value);
      const closePrice= num($('closePrice').value);
      const closeQty  = num($('closeQty').value);
      const currentPrice = num($('currentPrice').value);
      const leverage = num($('leverage').value);
      const notionalValue = num($('notionalValue').value);
      const rates = getRates();
      const realizedQty = Math.min(openQty||0, closeQty||0);
      const remainingQty = Math.max(0, (openQty||0) - (closeQty||0));
      const openRate  = state.feeOpen==='maker' ? rates.maker : rates.taker;
      const closeRate = state.feeClose==='maker' ? rates.maker : rates.taker;
      const feeOpen  = (Number.isFinite(openPrice)&&Number.isFinite(openQty)) ? openPrice  * openQty  * openRate : NaN;
      const feeClose = (Number.isFinite(closePrice)&&Number.isFinite(closeQty)) ? closePrice * closeQty * closeRate : NaN;
      const feeTotal = (Number.isFinite(feeOpen)&&Number.isFinite(feeClose)) ? (feeOpen + feeClose) : NaN;
      let pnlRaw = NaN;
      if (Number.isFinite(openPrice) && Number.isFinite(closePrice) && Number.isFinite(realizedQty)) {
        pnlRaw = state.side==='long' ? realizedQty * (closePrice - openPrice)
                                     : realizedQty * (openPrice - closePrice);
      }
      const pnlNet = (Number.isFinite(pnlRaw) && Number.isFinite(feeTotal)) ? (pnlRaw - feeTotal) : NaN;
      // 未实现盈亏（固定按剩余持仓量，不含手续费）
      let pnlUnreal = NaN;
      const unrealQty = remainingQty;
      if (Number.isFinite(openPrice) && Number.isFinite(currentPrice) && Number.isFinite(unrealQty) && unrealQty>0) {
        pnlUnreal = state.side==='long' ? unrealQty * (currentPrice - openPrice)
                                        : unrealQty * (openPrice - currentPrice);
      }
      const notional = (Number.isFinite(openPrice) && Number.isFinite(openQty)) ? openPrice * openQty : NaN;
      // 计算开仓数量（币）= 名义价值 / 开仓价格
      const openQtyResult = (Number.isFinite(notionalValue) && Number.isFinite(openPrice) && openPrice>0) ? notionalValue / openPrice : NaN;
      renderResults({feeOpen, feeClose, feeTotal, pnlRaw, pnlNet, pnlUnreal, notional, openQtyResult});
    }
    function renderResults(res){
      const dash = '-';
      const set = (id, txt, cls)=>{ const el=$(id); el.textContent=txt; el.className='value'+(cls?(' '+cls):''); };
      if(!res){
        ['feeOpen','feeClose','feeTotal','pnlRaw','pnlNet','pnlUnreal','notional','openQtyResult']
          .forEach(id=> set(id, dash));
        return;
      }
      $('feeOpen').textContent = fmtMoney(res.feeOpen);
      $('feeClose').textContent = fmtMoney(res.feeClose);
      $('feeTotal').textContent = fmtMoney(res.feeTotal);
      $('notional').textContent = fmtPlain(res.notional);
      $('openQtyResult').textContent = Number.isFinite(res.openQtyResult) ? res.openQtyResult.toFixed(8) : '-';
      $('pnlRaw').textContent = fmtMoney(res.pnlRaw);
      $('pnlRaw').className = 'value ' + (Number.isFinite(res.pnlRaw) && res.pnlRaw>=0?'pos':'neg');
      $('pnlNet').textContent = fmtMoney(res.pnlNet);
      $('pnlNet').className = 'value ' + (Number.isFinite(res.pnlNet) && res.pnlNet>=0?'pos':'neg');
      $('pnlUnreal').textContent = fmtMoney(res.pnlUnreal);
      $('pnlUnreal').className = 'value ' + (Number.isFinite(res.pnlUnreal) && res.pnlUnreal>=0?'pos':'neg');
    }
    // 初始化
    window.addEventListener('DOMContentLoaded', ()=>{
      setLang('zh');
      $('exampleBtn').click();
    });
  </script>
</body>
</html>
